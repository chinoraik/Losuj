<!DOCTYPE html>
<html>
<head>
    <title>Losuj!</title>
    <script src="https://www.gstatic.com/firebasejs/9.21.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.21.0/firebase-database.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 50px;
        }
        h1 {
            color: darkblue;
        }
        #result {
            margin-top: 20px;
            font-size: 24px;
            font-weight: bold;
            color: green;
        }
    </style>
</head>
<body>
    <h1>Generátor náhodného čísla</h1>
    <div id="result"></div>

    <script>
        // Firebase konfigurace
        const firebaseConfig = {
            apiKey: "AIzaSyBQUmhoGLk8y7b2c7xTXoAhdsKyycVVutk",
            authDomain: "generator-1a774.firebaseapp.com",
            databaseURL: "https://generator-1a774-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "generator-1a774",
            storageBucket: "generator-1a774.firebasestorage.app",
            messagingSenderId: "615580881065",
            appId: "1:615580881065:web:1fe90ea65a27c7587199b8"
        };

        // Inicializace Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Získání tokenu z URL
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get("token");

        // Ověření tokenu
        async function verifyToken(token) {
            const tokenRef = database.ref(`tokens/${token}`);
            const snapshot = await tokenRef.get();

            if (!snapshot.exists() || snapshot.val().status !== "valid") {
                document.body.innerHTML = "<h1>Token není platný nebo byl již použit!</h1>";
                return null;
            }

            return tokenRef;
        }

        // Vygenerování čísla a aktualizace databáze
        async function generateNumber(tokenRef) {
            const randomNumber = Math.floor(Math.random() * 299) + 1;

            // Uložit vygenerované číslo a změnit stav tokenu na 'used'
            await tokenRef.update({
                status: "used",
                number: randomNumber
            });

            // Zobrazit výsledek
            document.getElementById("result").textContent = `Vygenerované číslo: ${randomNumber}`;
        }

        // Hlavní logika
        (async function () {
            if (!token) {
                document.body.innerHTML = "<h1>Token není uveden v URL!</h1>";
                return;
            }

            const tokenRef = await verifyToken(token);
            if (tokenRef) {
                generateNumber(tokenRef);
            }
        })();
    </script>
</body>
</html>