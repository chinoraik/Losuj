<!DOCTYPE html>
<html>
<head>
    <title>Losuj!</title>
    <script src="https://www.gstatic.com/firebasejs/9.21.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.21.0/firebase-database.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 50px;
        }
        button {
            padding: 10px 20px;
            font-size: 18px;
            cursor: pointer;
        }
        #result {
            margin-top: 20px;
            font-size: 24px;
            font-weight: bold;
            color: green;
        }
    </style>
</head>
<body>
    <h1>Generátor náhodného čísla</h1>
    <button id="generateBtn" onclick="startRandom()">Losuj!</button>
    <div id="result"></div>

    <script>
        // Firebase konfigurace
        const firebaseConfig = {
            apiKey: "AIzaSyBQUmhoGLk8y7b2c7xTXoAhdsKyycVVutk",
            authDomain: "generator-1a774.firebaseapp.com",
            databaseURL: "https://generator-1a774-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "generator-1a774",
            storageBucket: "generator-1a774.firebasestorage.app",
            messagingSenderId: "615580881065",
            appId: "1:615580881065:web:1fe90ea65a27c7587199b8"
        };

        // Inicializace Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Získání tokenu z URL
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get("token");

        // Ověření tokenu
        async function verifyToken(token) {
            const tokenRef = database.ref(`tokens/${token}`);
            const snapshot = await tokenRef.get();

            if (!snapshot.exists() || snapshot.val().status !== "valid") {
                document.body.innerHTML = "<h1>Token není platný nebo byl již použit!</h1>";
                return null;
            }

            return tokenRef;
        }

        // Funkce animace a generování čísla
        let interval;
        async function startRandom() {
            const button = document.getElementById("generateBtn");
            button.disabled = true; // Deaktivujeme tlačítko, aby uživatel nemohl klikat vícekrát

            const tokenRef = await verifyToken(token);
            if (!tokenRef) return;

            const resultDiv = document.getElementById('result');
            let currentNumber = 1;

            // Rychlá animace čísel
            clearInterval(interval);
            interval = setInterval(() => {
                currentNumber = Math.floor(Math.random() * 299) + 1;
                resultDiv.textContent = `Losuje se: ${currentNumber}`;
            }, 50);

            // Po 3 sekundách zastavení a zobrazení finálního čísla
            setTimeout(async () => {
                clearInterval(interval);
                const finalNumber = Math.floor(Math.random() * 299) + 1;

                // Aktualizujeme databázi s výsledkem
                await tokenRef.update({
                    status: "used",
                    number: finalNumber
                });

                resultDiv.textContent = `Vygenerované číslo: ${finalNumber}`;
            }, 3000);
        }
    </script>
</body>
</html>